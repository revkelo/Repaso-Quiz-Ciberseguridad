<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz — Matriz y Operacionalización de Variables</title>

  <!-- Tailwind sin preflight -->
  <script>window.tailwind = { config: { corePlugins: { preflight: false } } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: light; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    /* glass claro */
    .glass{ background: rgba(255,255,255,.78); backdrop-filter: blur(10px); }
    .choice:hover{ transform: translateY(-1px); }
    .choice[aria-pressed="true"]{ outline: 2px solid rgb(14 165 233 / 1); outline-offset: 0; }
    .shake{ animation: shake .25s ease-in-out 0s 2; }
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-2px)}50%{transform:translateX(2px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
    /* Scrollbar fino */
    .thin-scrollbar{ scrollbar-width: thin; scrollbar-color: rgb(148 163 184) transparent; }
    .thin-scrollbar::-webkit-scrollbar{ width: 8px; }
    .thin-scrollbar::-webkit-scrollbar-track{ background: transparent; }
    .thin-scrollbar::-webkit-scrollbar-thumb{ background-color: rgb(148 163 184); border-radius: 8px; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-100 text-slate-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- HEADER -->
    <header class="flex items-center justify-between gap-4 mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Quiz — Matriz y Operacionalización</h1>
      <button id="btnReset" class="hidden px-3 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-slate-200 transition">
        Reiniciar
      </button>
    </header>

    <!-- INICIO -->
    <section id="setup" class="glass rounded-2xl p-6 shadow-xl border border-slate-200">
      <div class="max-w-2xl">
        <p class="text-sm mb-2 font-semibold opacity-80">Opciones</p>
        <label class="inline-flex items-center gap-2">
          <input id="shuffle" type="checkbox" class="accent-sky-600">
          <span>Barajar</span>
        </label>

        <div class="hidden">
          <label for="limit" class="text-sm opacity-80">Límite de preguntas</label>
          <input id="limit" type="number" min="1" step="1"
                 class="w-24 px-3 py-1.5 rounded-lg bg-white border border-slate-200 focus:outline-none"
                 placeholder="todas" />
        </div>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="btnStart" class="px-4 py-2 rounded-2xl bg-sky-600 hover:bg-sky-500 text-white font-semibold">
            Iniciar
          </button>
          <button id="btnShowAll" class="px-4 py-2 rounded-2xl bg-white/80 border border-slate-200 hover:bg-slate-200">
            Vista de estudio
          </button>
        </div>
      </div>
    </section>

    <!-- VISTA DE ESTUDIO -->
    <section id="study" class="hidden mt-6 glass rounded-2xl p-5 sm:p-6 shadow-xl border border-slate-200">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Vista de estudio (todas las preguntas)</h2>
        <button class="px-3 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-slate-200" onclick="closeStudy()">
          Cerrar
        </button>
      </div>
      <div id="studyList" class="space-y-6"></div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" class="hidden mt-6">
      <div class="grid grid-cols-1 md:[grid-template-columns:280px_1fr] lg:[grid-template-columns:300px_1fr] gap-6 items-start">
        <!-- SIDEBAR -->
        <aside class="w-full">
          <div class="glass rounded-2xl p-4 sm:p-5 shadow-xl border border-slate-200 md:sticky md:top-4 max-h-[calc(100vh-2rem)] overflow-y-auto thin-scrollbar">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div class="text-sm opacity-80" id="progress">Pregunta 1 / N</div>
              <div class="text-xs opacity-60" id="meta"></div>
            </div>
            <div class="text-xs opacity-70" id="counter">0/N respondidas</div>

            <div id="navGrid" class="mt-3 grid grid-cols-5 gap-x-1.5 gap-y-3 pr-2 auto-rows-[44px]"></div>
          </div>
        </aside>

        <!-- CONTENIDO -->
        <main class="flex-1">
          <div class="glass rounded-2xl p-5 sm:p-6 shadow-xl border border-slate-200">
            <h2 id="qtext" class="text-xl sm:text-2xl font-semibold leading-snug mb-4"></h2>

            <div id="multiHint" class="text-xs text-sky-700 mb-3 hidden">
              Esta pregunta admite varias respuestas. Selecciona todas las que apliquen.
            </div>

            <div id="choices" class="grid gap-3"></div>

            <div class="mt-5 pt-4 border-t border-slate-200">
              <div class="flex flex-col-reverse sm:flex-row sm:items-center gap-3">
                <div class="flex gap-3 sm:mr-auto">
                  <button id="btnPrevMain" class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-slate-200">
                    Anterior
                  </button>
                  <button id="btnNextMain" class="px-4 py-2 rounded-2xl bg-sky-600 hover:bg-sky-500 text-white font-semibold">
                    Siguiente
                  </button>
                </div>
                <button id="btnCheckMain" class="px-4 py-2 rounded-2xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold">
                  Comprobar
                </button>
              </div>
            </div>
          </div>

          <!-- Resultados -->
          <div id="results" class="hidden mt-6 glass rounded-2xl p-5 sm:p-6 border border-slate-200 shadow-xl">
            <h3 class="text-xl font-bold mb-2">Resultados</h3>
            <p id="score"></p>
            <div class="mt-4 flex flex-wrap gap-3">
              <button onclick="review()" class="px-4 py-2 rounded-2xl bg-white/80 border border-slate-200 hover:bg-slate-200">
                Revisar respuestas
              </button>
              <button id="btnRestart" class="px-4 py-2 rounded-2xl bg-sky-600 hover:bg-sky-500 text-white font-semibold">
                Volver a empezar
              </button>
            </div>
          </div>
        </main>
      </div>
    </section>

    <footer class="mt-10 text-xs opacity-60 text-center">Repaso</footer>
  </div>

  <!-- Banco de preguntas -->
  <script src="preguntas.js"></script>

  <script>
    // ------------ Estado / refs
    const Setup = {
      shuffle: document.getElementById('shuffle'),
      start: document.getElementById('btnStart'),
      showAll: document.getElementById('btnShowAll'),
    };

    const Quiz = {
      wrap: document.getElementById('quiz'),
      setup: document.getElementById('setup'),
      study: document.getElementById('study'),
      studyList: document.getElementById('studyList'),
      progress: document.getElementById('progress'),
      meta: document.getElementById('meta'),
      qtext: document.getElementById('qtext'),
      multiHint: document.getElementById('multiHint'),
      choices: document.getElementById('choices'),
      counter: document.getElementById('counter'),
      navGrid: document.getElementById('navGrid'),
      btnPrev: document.getElementById('btnPrevMain'),
      btnNext: document.getElementById('btnNextMain'),
      btnCheck: document.getElementById('btnCheckMain'),
      results: document.getElementById('results'),
      score: document.getElementById('score'),
      btnRestart: document.getElementById('btnRestart'),
      btnReset: document.getElementById('btnReset'),
    };

    let state = {
      items: [],
      i: 0,
      answers: {},
      checked: {},
      optionOrder: {},
    };

    // ------------ Banco y arranque
    function selectBank(){ return dedupeByText(RAW); }

    function startQuiz(){
      const pool = selectBank();
      let list = [...pool];
      if (Setup.shuffle.checked) shuffle(list);

      state.items = list;
      state.i = 0;
      state.answers = {};
      state.checked = {};
      state.optionOrder = {};

      for(const q of state.items){
        const opts = [...q.options];
        if (Setup.shuffle.checked) shuffle(opts);
        state.optionOrder[q.id] = opts;
      }

      Quiz.setup.classList.add('hidden');
      Quiz.wrap.classList.remove('hidden');
      Quiz.results.classList.add('hidden');
      Quiz.btnReset.classList.remove('hidden');

      renderQuestion();
      renderGrid();
      updateNextButton();
    }

    // ------------ Render pregunta
    function renderQuestion(){
      const q = state.items[state.i];
      const multi = q.correct.length > 1 || (q.subtitle || '').toLowerCase().includes('todas');
      Quiz.qtext.textContent = q.text + (q.subtitle ? ' ' + q.subtitle : '');
      Quiz.multiHint.classList.toggle('hidden', !multi);

      Quiz.progress.textContent = `Pregunta ${state.i + 1} / ${state.items.length}`;
      Quiz.meta.textContent = `${q.id} • ${String(q.parcial || '').toUpperCase()}`;

      const selected = new Set(state.answers[q.id] || []);
      Quiz.choices.innerHTML = '';

      const opts = state.optionOrder[q.id] ?? q.options;
      opts.forEach(([letter, text])=>{
        const isOn = selected.has(letter);
        const btn = document.createElement('button');
        btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
        btn.className = [
          'choice w-full text-left px-4 py-3 rounded-xl border transition',
          isOn ? 'border-sky-500 bg-sky-50' : 'border-slate-200 bg-white/80 hover:border-sky-500',
        ].join(' ');
        btn.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="mt-1 shrink-0 w-6 h-6 rounded-lg border ${isOn ? 'border-sky-400 bg-sky-100' : 'border-slate-300 bg-slate-50'}"></div>
            <div>
              <div class="font-semibold">${letter})</div>
              <div class="opacity-90">${text}</div>
            </div>
          </div>`;
        btn.addEventListener('click', ()=>{
          toggleSelect(q.id, letter, multi);
          renderQuestion();
          highlightSelection(q);
        });
        Quiz.choices.appendChild(btn);
      });

      updateCounter();
      updateNextButton();
    }

    function toggleSelect(qid, letter, multi){
      const sel = new Set(state.answers[qid] || []);
      if(!multi) sel.clear();
      sel.has(letter) ? sel.delete(letter) : sel.add(letter);
      state.answers[qid] = [...sel];
    }

    // ------------ Corrección
    function highlightSelection(q){
      if(!state.checked[q.id]) return;
      const correct = new Set(q.correct);
      const userSel = new Set(state.answers[q.id] || []);

      [...Quiz.choices.children].forEach((el)=>{
        const letter = el.querySelector('.font-semibold')?.textContent?.replace(')','');
        el.classList.remove('shake');
        el.classList.remove('border-emerald-500','bg-emerald-50','border-rose-500','bg-rose-50');

        if (correct.has(letter)) el.classList.add('border-emerald-500','bg-emerald-50');
        if (userSel.has(letter) && !correct.has(letter)) el.classList.add('border-rose-500','bg-rose-50','shake');
      });
    }

    function checkCurrent(showToast=true){
      const q = state.items[state.i];
      const user = new Set(state.answers[q.id] || []);
      const need = new Set(q.correct);
      const ok = user.size === need.size && [...user].every(x => need.has(x));
      state.checked[q.id] = true;
      highlightSelection(q);
      if (showToast) toast(ok ? '¡Correcto!' : 'Revisa tu respuesta');
      renderGrid();
      return ok;
    }

    // ------------ Grid de navegación
    function renderGrid () {
      const grid = Quiz.navGrid;
      grid.innerHTML = '';

      state.items.forEach((q, idx) => {
        const answered = (state.answers[q.id] || []).length > 0;
        const need    = new Set(q.correct || []);
        const user    = new Set(state.answers[q.id] || []);
        const checked = !!state.checked[q.id];
        const ok      = checked && user.size === need.size && [...user].every(x => need.has(x));
        const wrong   = checked && !ok && answered;

        let ringClass = '';
        if (ok) ringClass = 'ring-inset ring-1 ring-emerald-500';
        else if (wrong) ringClass = 'ring-inset ring-1 ring-rose-500';
        else if (idx === state.i) ringClass = 'ring-inset ring-1 ring-sky-500';

        const baseBorder = ringClass ? 'border-transparent' : 'border-slate-200';

        const textColor  = ok ? 'text-emerald-700'
                        : wrong ? 'text-rose-700'
                        : answered ? 'text-sky-700'
                        : 'text-slate-400';

        const statusIcon = ok ? '✓' : wrong ? '!' : answered ? '•' : '–';

        const barClass = ok ? 'bg-emerald-500/25'
          : wrong ? 'bg-rose-500/25'
          : answered ? 'bg-sky-500/25'
          : 'bg-slate-400/25';

        const b = document.createElement('button');
        b.type = 'button';
        b.className = [
          'relative box-border w-9 h-[44px] shrink-0 rounded-[6px] p-0.5',
          'flex flex-col items-center justify-between',
          'text-[10px] leading-none font-medium select-none',
          `border ${baseBorder} bg-white/80 hover:bg-slate-100 transition`,
          'focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-sky-400',
          'overflow-hidden',
          ringClass
        ].join(' ');

        b.innerHTML = `
          <span class="mt-1">${idx + 1}</span>
          <span class="text-[9px] ${textColor}">${statusIcon}</span>
          <span class="w-full h-[6px] rounded-[3px] ${barClass}"></span>
        `;

        b.setAttribute('aria-label', `Ir a la pregunta ${idx + 1}`);
        if (idx === state.i) b.setAttribute('aria-current', 'true');

        b.addEventListener('click', () => {
          state.i = idx;
          renderQuestion();
          highlightSelection(state.items[state.i]);
          renderGrid();
        });

        grid.appendChild(b);
      });
    }

    // ------------ Navegación
    function next(){
      if (state.i < state.items.length - 1){
        state.i++;
        renderQuestion();
        highlightSelection(state.items[state.i]);
      }
    }
    function prev(){
      if (state.i > 0){
        state.i--;
        renderQuestion();
        highlightSelection(state.items[state.i]);
      }
    }

    function updateCounter(){
      const answered = Object.keys(state.answers).filter(k => (state.answers[k]||[]).length>0).length;
      Quiz.counter.textContent = `${answered}/${state.items.length} respondidas`;
    }

    function finish(){
      state.items.forEach(q => { if(!state.checked[q.id]) state.checked[q.id] = true; });
      const totals = score();
      Quiz.results.classList.remove('hidden');
      Quiz.score.textContent = `Puntaje: ${totals.ok} correctas de ${state.items.length} ( ${(totals.ok / state.items.length * 100).toFixed(1)}% )`;
      renderGrid();
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function review(){ toast('Modo revisión: usa la cuadrícula para navegar'); }

    function score(){
      let ok = 0;
      state.items.forEach(q=>{
        const u = new Set(state.answers[q.id] || []);
        const need = new Set(q.correct);
        const yes = u.size === need.size && [...u].every(x => need.has(x));
        if (yes) ok++;
      });
      return { ok };
    }

    // ------------ Estudio
    function closeStudy(){
      Quiz.study.classList.add('hidden');
      Quiz.studyList.innerHTML='';
    }

    function openStudy(){
      const list = [...selectBank()];
      if (Setup.shuffle.checked) shuffle(list);
      const c = Quiz.studyList; c.innerHTML = '';

      list.forEach(q=>{
        const multi = q.correct.length > 1 || (q.subtitle || '').toLowerCase().includes('todas');
        const block = document.createElement('div');
        block.innerHTML = `
          <div class="rounded-xl border border-slate-200 bg-white/80">
            <div class="p-4">
              <div class="text-xs opacity-70 mb-1">${q.id} • ${String(q.parcial || '').toUpperCase()} ${multi ? '• múltiple' : ''}</div>
              <div class="font-semibold mb-3">${q.text} ${q.subtitle ? `<span class='text-sky-700'>${q.subtitle}</span>` : ''}</div>
              <ul class="space-y-2">
                ${q.options.map(([L, T]) => `<li class="rounded-lg border border-slate-200 px-3 py-2 bg-white">${L}) ${T}</li>`).join('')}
              </ul>
              <div class="mt-3 text-sm">
                <span class="opacity-70">Respuesta correcta:</span>
                <span class="font-mono">${q.correct.join(', ')}</span>
              </div>
            </div>
          </div>`;
        c.appendChild(block);
      });

      Quiz.study.classList.remove('hidden');
    }

    // ------------ Utils
    function dedupeByText(arr){
      const seen = new Set(), out = [];
      for(const q of arr){
        const key = (q.text||'').toLowerCase().replace(/\s+/g,' ').trim();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(q);
      }
      return out;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/90 border border-slate-200 px-4 py-2 rounded-xl text-sm shadow-xl';
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 1500);
    }

    // ------------ Eventos
    Setup.start.addEventListener('click', startQuiz);
    Setup.showAll.addEventListener('click', openStudy);

    Quiz.btnPrev.addEventListener('click', prev);
    Quiz.btnCheck.addEventListener('click', ()=>{ checkCurrent(true); });

    Quiz.btnReset.addEventListener('click', ()=>{
      Quiz.wrap.classList.add('hidden');
      Quiz.setup.classList.remove('hidden');
      Quiz.results.classList.add('hidden');
      Quiz.btnReset.classList.add('hidden');
      closeStudy();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    Quiz.btnRestart.addEventListener('click', ()=>{
      Quiz.wrap.classList.add('hidden');
      Quiz.setup.classList.remove('hidden');
      Quiz.results.classList.add('hidden');
      Quiz.btnReset.classList.add('hidden');
      closeStudy();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('keydown', (e)=>{
      if (Quiz.wrap.classList.contains('hidden')) return;
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft') prev();
      if (e.key === 'Enter') checkCurrent();
    });

    function updateNextButton(){
      const last = state.i === state.items.length - 1;
      Quiz.btnNext.textContent = last ? 'Finalizar' : 'Siguiente';
      Quiz.btnNext.onclick = last ? finish : ()=>{
        const ok = checkCurrent(false);
        toast(ok ? 'Correcto' : 'Aún no es correcto');
        next();
      };
    }
  </script>
</body>
</html>
